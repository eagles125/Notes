Content-Type: text/x-zim-wiki
Wiki-Format: zim 0.4
Creation-Date: 2013-05-30T21:28:21+08:00

====== 详解SAS硬盘驱动器的连接方法 ======
Created Thursday 30 May 2013

http://tech.watchstor.com/storage-module-114224.htm

SAS首先定义了硬盘驱动器的接口连接器，其规范即SFF-8482。由于SAS兼容SATA，既要向下兼容SATA硬盘驱动器，又不能让SATA的数据线连接到SAS硬盘驱动器上，SFF-8482规范的制订者们很是下了一番心思。
{{./1}}


SFF-8482规范定义的SAS线缆端插座，引脚S1-S7是主端口，另一侧的S8-S14是从端口，而P1-P15的供电部分在SATA是分离的

SFF-8482定义了SAS硬盘驱动器的双端口（dual port）插头，SATA数据线无法与之相连，而符合SFF-8482规范的插座（位于SAS线缆和背板）却可以随意接纳SAS硬盘驱动器或SATA硬盘驱动器。
{{./2.jpg}}


SAS硬盘驱动器的双端口连接器（上-中）与SATA硬盘驱动器的连接器（下）对比

众所周知，SATA硬盘驱动器的SATA端口和电源供应是分离的，两个连接器之间有大约2个（SATA或电源）引脚宽度的间隙。SAS硬盘驱动器的做法是打掉“隔断”，将双方连为一体，第二端口就位于这个4～5个SATA信号引脚宽度的“桥”的背面。虽然空间利用得很充分，可毕竟也要布置7个信号引脚，所以从端口（Secondary Port，SAS②）和主端口（Primary Port，SAS①）的“个头”在上面的实物对比图中看起来就像武大郎和武松一样差别明显——当然，仅是针对宽度而言，引脚定义及传递信号的能力是没有区别的。
{{./3}}


SAS硬盘驱动器（上）和SATA（下）硬盘驱动器的连接器在这个投影方向上的主要区别是有无隔断，前者的轮廓包容了后者，使它们共用SAS线缆连接器成为可能

由于SAS硬盘驱动器的接口连接器只是比SATA（加电源）多出来一个从端口，所以SAS线缆连接器很自然地就能兼容SATA硬盘驱动器，反之（SATA线缆配SAS硬盘驱动器）则因受到从端口的阻隔而行不通。这种设计能够避免SATA HBA/RAID卡（不支持后者所需的STP协议）访问SAS硬盘驱动器，从而满足了“防呆”的要求。

{{./4}}

SAS线缆既可以连接SAS硬盘驱动器（左），也能够连接SATA硬盘驱动器（右）——注意红色箭头所指处缺口的有无，以及硬盘驱动器接口连接器上引脚数量的差异

如上图所示，将主端口、从端口和电源供应融为一体的SAS线缆连接器（共29个引脚），与SAS硬盘驱动器的接口连接器一同由小型化委员会（SFF Committee）制订的SFF-8482规范（非屏蔽双端口串行附加连接器）定义，也被称为“SAS样式连接器”；与之相对应，原来用于连接SATA硬盘驱动器的信号电缆，其连接器只有7个数据引脚，被称为“SATA样式连接器”。


{{./5}}
SATA数据线缆（左）与SAS线缆的SFF-8482端对比

SATA样式的线缆是数据与电源供应相分离的设计，而SFF-8482规范定义的SAS插头连接器和插座连接器却不得不把主/从两个端口和供应电源的针脚整合在一起，上图中很清楚地体现出了两者的区别。需要强调的是，无论SAS硬盘驱动器还是SATA，驱动器上的都是“插头”，相配合的“插座”位于线缆一端，切记不要搞反了……

SAS样式连接器的好处当然是用起来方便，但在连接SAS硬盘驱动器时，却也有个潜在的问题——并不是用SAS样式（SFF-8482规范）的插座与SAS硬盘驱动器驱动器的插头相连就可以实现双端口功能。

{{./6}}

SAS硬盘驱动器上的双端口分别连接到两个SAS HBA/RAID卡，以提高可用性

我们必须明确，SAS设备端（device，主要指驱动器）设计双端口功能，初衷不是为了提高带宽，而是要防止主机端出现单点故障，提高SAS硬盘驱动器的可用性。因此，SAS硬盘驱动器连接插头上的两个端口，不能连接到同一个SAS主机控制器设备（SAS IC/HBA/RAID卡）乃至同一台主机上（SAS host），而是有主、从（Primary和Secondary）之分，分别连接到两个SAS HBA或RAID卡上，采用Active-Active（双活）模式，确保任何一个SAS HBA/RAID卡出故障时，SAS硬盘驱动器仍能被另一个SAS HBA/RAID所在的主机访问，如上图所示。
{{./7}}


SAS线缆直连的典型状况——无法实现双端口

然而，多数情况下，配合SAS HBA/RAID卡使用的SAS线缆，无法同时连接到两个SAS HBA/RAID卡上。在SAS HBA/RAID卡通过SAS线缆直接与SAS硬盘驱动器相连的时候，因为SAS规范不允许SAS硬盘驱动器的两个端口连接到同一HBA/RAID卡（前面已经说过，双端口设计不是为了增加带宽，而是高可用性和容灾的需要），所以这些SAS线缆上每一个用于连接SAS硬盘驱动器的SAS样式连接器只分配了一根单端口的连接线，如上图所示。换句话说，这样的SAS样式连接器受对外（主机端）为单路连接的限制，实际上仅有主端口是可用的，但在插入后却无法避免地将SAS硬盘驱动器的从端口一并占据，反而令双端口功能形同虚设。


{{./8}}
ADP-4000 SAS热插拔背板适配器上的SAS样式连接器，用于连接SAS硬盘驱动器

所以，若想要双端口发挥作用，SAS样式连接器通常应该出现在磁盘背板上，接纳SAS硬盘驱动器的插入，而另一侧可以是一对SATA样式连接器（分别对应SAS样式连接器的主、从端口），迎接来自两个HBA/RAID卡上的SAS线缆，实现高可用性。



CS Electronics出品的ADP-4000 SAS热插拔背板适配器，可以把它当作一个“迷你背板”

正因如此，某些SAS HBA/RAID卡配套的SAS线缆，在设备一端用的不是SAS样式连接器，而是利于实现双端口的SATA样式连接器。然而，前面已经介绍过，SATA样式连接器不能插入SAS硬盘驱动器。在这种情况下，可以使用上图所示的SAS-SATA适配器：一端为SAS样式连接器，用来插入SAS硬盘驱动器；另一端（也就是面对我们的）有两个分为主、从的SATA样式连接器，对应SAS硬盘驱动器的两个端口，采用SATA样式连接器的SAS线缆插入标有“主信号”（Signal-Primary）的连接器，便可通过SAS硬盘驱动器的主端口访问，另一个（Signal-Secondary）同理类推。如果两者各连一个SAS HBA/RAID卡，还能组成高可用性配置。


{{./9}}
红色椭圆圈内可以作为一个在SAS背板上实现双端口的范例——主机侧两个SATA样式连接器（上），分别对应SAS样式连接器（下）的主、从端口，如红色箭头所示

为了进一步展示双端口在SAS背板上的实现，不妨以SuperMicro的SAS825TQ背板来加以说明，如上图。

需要强调的是，作为一款主要用于服务器的SAS硬盘驱动器，SAS825TQ并不支持双端口，其上的每一个SAS样式连接器只对应主机侧的一个SATA样式连接器，除非去掉半数的SAS样式连接器，否则红色椭圆圈内的情况不会出现。当然，将SATA样式连接器的数量增加一倍也可以，但过多孤立的连接器又会带来占地面积过大和不利于布线的问题。
